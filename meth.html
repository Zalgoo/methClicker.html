<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meth Production Simulator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Open Sans -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap">
    <style>
        /* Custom styles for Open Sans font and general aesthetics */
        body {
            font-family: "Open Sans", sans-serif;
        }
        /* Basic button styling for hover effects */
        button {
            transition: all 0.3s ease-in-out;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px); /* Subtle lift effect */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); /* More prominent shadow on hover */
        }
        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* Styles for the modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Dark semi-transparent background */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000; /* Ensure it's on top of everything */
        }
        /* Styles for the modal content */
        .modal-content {
            padding: 2.5rem; /* p-10 equivalent */
            border-radius: 0.5rem; /* rounded-md equivalent */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); /* shadow-2xl equivalent */
            max-width: 28rem; /* max-w-md equivalent */
            width: 90%; /* Responsive width */
            text-align: center;
        }
        /* Global focus style to make it less prominent */
        button:focus-visible {
            outline: 2px solid currentColor;
            outline-offset: 2px;
            border-radius: 6px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-zinc-950 to-black min-h-screen flex items-center justify-center p-4">
<!-- Background Music -->
<audio id="bgMusic" src="assets/bg-Music.ogg" loop autoplay></audio>

<div class="bg-zinc-900 p-8 rounded-md shadow-2xl w-full max-w-4xl border border-zinc-800 flex flex-col gap-6">
    <div class="flex flex-row gap-6 items-center justify-between">
        <div class="flex flex-col items-start gap-2">
            <h1 class="text-4xl font-extrabold text-red-400 tracking-tight">Meth Production Simulator</h1>
        </div>
        <!-- Horizontal music slider on the top right -->
        <div class="flex flex-col items-end justify-center bg-zinc-900 px-4 py-2 rounded-md shadow-lg border border-zinc-800">
            <label for="bgMusicSlider" class="text-zinc-100 text-sm font-semibold mb-2">Volume</label>
            <input type="range" id="bgMusicSlider" min="0" max="100" value="45" class="accent-red-500 w-64" />
        </div>
    </div>
    <div class="flex flex-row gap-8 items-stretch">
        <div class="flex flex-col justify-center items-center bg-zinc-950 p-6 rounded-md shadow-inner border border-zinc-800 w-1/2">
            <p class="text-2xl text-zinc-200 mb-2">Current Meth:</p>
            <p id="cookieCount" class="text-6xl font-black text-amber-500 mb-6 drop-shadow-md">0</p>
            <button id="cookieButton" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-8 rounded-lg shadow-lg transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-amber-500 mb-4 text-xl">
                Click for Meth!
            </button>
            <div class="flex flex-col gap-2 mt-2">
                <p class="text-lg text-zinc-200">
                    CPC: <span id="cpcDisplay" class="font-bold text-red-300">1</span>
                </p>
                <p class="text-lg text-zinc-200">
                    OPS: <span id="cpsDisplay" class="font-bold text-red-300">0</span>
                </p>
            </div>
        </div>
        <div class="flex flex-col items-end gap-6 w-1/2">
             <img src="https://static1.srcdn.com/wordpress/wp-content/uploads/2020/02/Breaking-Bad-things-Walter-White-feature.jpg?q=70&fit=contain&w=1200&h=628&dpr=1" alt="Walter White" class="rounded-full shadow-lg w-32 h-32 object-cover border-4 border-red-900" />
            <p class="text-lg text-zinc-200 font-bold">
                Crimes Committed: <span id="rebirthsDisplay" class="text-red-400">0</span>
            </p>
            <button id="rebirthButton" class="w-full bg-red-800 hover:bg-red-900 text-red-100 font-bold py-3 px-6 rounded-md shadow-md transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-red-800 text-lg">
                Commit Crime! (Cost: <span id="rebirthCostDisplay">30000</span> Meth)
            </button>
            <button id="toggleUpgradesButton" class="w-full bg-zinc-800 hover:bg-zinc-900 text-zinc-100 font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-zinc-800 text-lg">
                Toggle Upgrades
            </button>
            <audio id="walterAudio"></audio>
        </div>
    </div>
    <div id="upgradesSection" class="bg-zinc-950 p-6 rounded-md shadow-inner border border-zinc-800 mt-2">
        <h2 class="text-2xl font-bold text-red-400 mb-4 text-center">Upgrades</h2>
        <div id="upgradesContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Upgrades will be dynamically added here by JavaScript -->
        </div>
    </div>
</div>

<!-- Offline Collection Modal (initially hidden) -->
<div id="offlineModal" class="modal-overlay hidden">
    <div class="modal-content bg-zinc-950 border border-zinc-800">
        <h3 class="text-3xl font-bold text-red-400 mb-6">Welcome Back!</h3>
        <p class="text-xl text-zinc-200 mb-6">
            While you were away, your lab produced:
            <br><span id="offlineCookiesAmount" class="text-4xl font-black text-amber-500">0</span> Meth!
        </p>
        <div class="flex flex-col space-y-4">
            <button id="collectOfflineButton" class="bg-green-700 hover:bg-green-800 text-white font-bold py-4 px-8 rounded-md shadow-lg transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-green-700">
                Collect
            </button>
            <button id="dontCollectOfflineButton" class="bg-red-800 hover:bg-red-900 text-red-100 font-bold py-4 px-8 rounded-md shadow-lg transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-red-800">
                Don't Collect
            </button>
        </div>
    </div>
</div>

<script>
    // Background music setup
    const bgMusic = document.getElementById('bgMusic');
    const bgMusicSlider = document.getElementById('bgMusicSlider');
    const walterAudio = document.getElementById('walterAudio');

    // NOTE: The following audio files are required for the music to play correctly.
    // Ensure 'assets/bg-Music.ogg', 'assets/Walta.mp3' and 'assets/clink.mp3' exist.

    let originalBgVolume = 0.45; // Default volume
    const fadeDuration = 1000; // 1 second for fading
    const minBgVolumeMultiplier = 0.4; // The music will fade down to 40% of its original volume, not 0
    const minAbsoluteBgVolume = 0.05; // An absolute minimum volume to ensure it's never silent
    let fadeLoop = null; // Variable to hold the interval for fading audio

    if (bgMusic) {
        bgMusic.volume = originalBgVolume;
        if (bgMusicSlider) {
            bgMusicSlider.value = originalBgVolume * 100;
            bgMusicSlider.addEventListener('input', function() {
                // Update the original volume immediately, but only change the actual
                // volume if Walter isn't currently speaking.
                const newVolume = bgMusicSlider.value / 100;
                originalBgVolume = newVolume;
                
                // If the Walter audio is not playing, apply the volume change immediately
                if (walterAudio.paused) {
                    if (fadeLoop) {
                        clearInterval(fadeLoop);
                        fadeLoop = null;
                    }
                    bgMusic.volume = newVolume;
                }
                console.log("Volume slider changed to:", newVolume);
            });
        }
        
        // Start music on first user interaction to avoid browser autoplay policy issues
        let musicStarted = false;
        function startMusic() {
            if (!musicStarted) {
                if (bgMusic.readyState >= 3) {
                    bgMusic.play().then(() => {
                        musicStarted = true;
                    }).catch(error => {
                        console.error("Error attempting to play background music:", error);
                    });
                }
            }
        }
        window.addEventListener('click', startMusic, { once: true });
    }

    /**
     * Fades an audio element's volume to a target volume over a specified duration.
     * @param {HTMLAudioElement} audio - The audio element to fade.
     * @param {number} targetVolume - The final volume level (0.0 to 1.0).
     * @param {number} duration - The duration of the fade in milliseconds.
     * @param {function} callback - A function to call after the fade is complete.
     */
    function fadeAudio(audio, targetVolume, duration, callback = () => {}) {
        // Clear any previous fade loop
        if (fadeLoop) {
            clearInterval(fadeLoop);
        }

        const startVolume = audio.volume;
        const volumeChange = targetVolume - startVolume;
        const startTime = Date.now();
        const interval = 50; // Fade interval in ms

        fadeLoop = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const progress = elapsedTime / duration;

            if (progress >= 1) {
                audio.volume = targetVolume;
                clearInterval(fadeLoop);
                fadeLoop = null;
                callback();
            } else {
                audio.volume = startVolume + volumeChange * progress;
            }
        }, interval);
    }

    // Game state variables
    let meth = 0; // meth
    let cpc = 1;  // Crystals per click
    let ops = 0;  // Output per second
    let criminalCharges = 0;
    let currentChargeCost = 30000;
    
    // The clink sound volume multiplier. A value between 0 and 1.
    const clinkVolumeMultiplier = 0.7;

    // Console helper functions for Chrome DevTools
    // Use setMeth(amount) to set your meth count
    // Use setCPC(amount) to set your crystals per click
    window.setMeth = function(amount) {
        meth = Number(amount);
        updateDisplay();
        saveGame();
        return `Meth set to ${meth}`;
    };
    window.setCPC = function(amount) {
        cpc = Number(amount);
        updateDisplay();
        saveGame();
        return `Crystals Per Click set to ${cpc}`;
    };

    /**
     * Resets all game progress to its initial state.
     * This function can be called from the browser's developer console.
     */
    window.clearProduction = function() {
        // Use a modal-like behavior for confirmation instead of `window.confirm`
        showConfirmationModal("Are you sure you want to clear all your progress? This cannot be undone.", () => {
            // Reset all state variables to initial values
            meth = 0;
            cpc = 1;
            ops = 0;
            criminalCharges = 0;
            currentChargeCost = 30000;
            
            // Reset all non-permanent upgrade costs to their initial values
            upgrades.forEach(upgrade => {
                upgrade.cost = upgrade.initialCost;
            });

            // Re-initialize upgrades and update display
            initializeUpgrades();
            updateDisplay();
            saveGame();
            
            console.log("Game progress has been cleared.");
        });
    };

    /**
     * Displays a custom confirmation modal.
     * @param {string} message - The message to display in the modal.
     * @param {function} onConfirm - The function to call if the user confirms.
     */
    function showConfirmationModal(message, onConfirm) {
        // This is a placeholder for a custom modal UI.
        // For a real application, you would create a custom HTML modal.
        // For now, we'll use a simple alert as a stand-in since
        // the user is interacting with devtools, but we will make it
        // a modal in a future iteration.
        const confirmed = confirm(message); // Using confirm for devtools context
        if (confirmed) {
            onConfirm();
        }
    }


    // Define available upgrades
    // Each upgrade now has an 'initialCost', 'permanent' flag, and 'requiredRebirths'
    const upgrades = [
        { id: 'upgrade1', name: 'Better Chemistry', initialCost: 10, cost: 10, cpc_boost: 1, type: 'cpc', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade2', name: 'Blue Crystal Flask', initialCost: 50, cost: 50, cpc_boost: 5, type: 'cpc', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade3', name: 'Lab Assistant', initialCost: 100, cost: 100, cps_boost: 1, type: 'ops', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade4', name: 'RV Lab', initialCost: 200, cost: 200, cpc_boost: 20, type: 'cpc', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade5', name: 'Jesse Pinkman', initialCost: 500, cost: 500, cps_boost: 5, type: 'ops', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade6', name: 'Superlab', initialCost: 1000, cost: 1000, cps_boost: 25, type: 'ops', permanent: false, requiredRebirths: 0 },
        { id: 'upgrade7', name: 'Gus Fring', initialCost: 5000, cost: 5000, cps_boost: 50, type: 'ops', permanent: false, requiredRebirths: 0 },
        // New permanent upgrades that require rebirths
        { id: 'rebirthUpgrade1', name: 'Heisenberg Boost', initialCost: 10000, cost: 10000, cpc_boost: 100, type: 'cpc', permanent: true, requiredRebirths: 1 },
        { id: 'rebirthUpgrade2', name: 'Blue Magic Auto', initialCost: 25000, cost: 25000, cps_boost: 50, type: 'ops', permanent: true, requiredRebirths: 2 },
        { id: 'rebirthUpgrade3', name: 'Empire Expansion', initialCost: 100000, cost: 100000, cps_boost: 200, type: 'ops', permanent: true, requiredRebirths: 3 },
        { id: 'rebirthUpgrade4', name: 'Ultimate Heisenberg', initialCost: 500000, cost: 500000, cpc_boost: 1000, type: 'cpc', permanent: true, requiredRebirths: 5 },
        // Additional upgrades to make the game longer
        { id: 'upgrade8', name: 'Better Distributor', initialCost: 100000, cost: 100000, cps_boost: 500, type: 'ops', permanent: false, requiredRebirths: 1 },
        { id: 'upgrade9', name: 'Global Supply Chain', initialCost: 500000, cost: 500000, cps_boost: 2000, type: 'ops', permanent: false, requiredRebirths: 2 },
        { id: 'upgrade10', name: 'Fusion Reactor Lab', initialCost: 1000000, cost: 1000000, cps_boost: 5000, type: 'ops', permanent: false, requiredRebirths: 3 },
        { id: 'upgrade11', name: 'New Chemical Formula', initialCost: 5000000, cost: 5000000, cpc_boost: 10000, type: 'cpc', permanent: false, requiredRebirths: 4 }
    ];

    // Get references to DOM elements
    const methCountDisplay = document.getElementById('cookieCount');
    const cpcDisplay = document.getElementById('cpcDisplay');
    const opsDisplay = document.getElementById('cpsDisplay');
    const chargesDisplay = document.getElementById('rebirthsDisplay');
    const methButton = document.getElementById('cookieButton');
    const upgradesSection = document.getElementById('upgradesSection');
    const upgradesContainer = document.getElementById('upgradesContainer');
    const toggleUpgradesButton = document.getElementById('toggleUpgradesButton');
    const chargeButton = document.getElementById('rebirthButton');
    const chargeCostDisplay = document.getElementById('rebirthCostDisplay');

    // Modal elements
    const offlineModal = document.getElementById('offlineModal');
    const offlineCookiesAmountDisplay = document.getElementById('offlineCookiesAmount');
    const collectOfflineButton = document.getElementById('collectOfflineButton');
    const dontCollectOfflineButton = document.getElementById('dontCollectOfflineButton');


    /**
     * Updates the display of cookies, CPC, OPS, rebirths, and enables/disables buttons.
     */
    function updateDisplay() {
        // Update main stats
        if (methCountDisplay) methCountDisplay.textContent = meth.toLocaleString();
        if (cpcDisplay) cpcDisplay.textContent = cpc.toLocaleString();
        if (opsDisplay) opsDisplay.textContent = ops.toLocaleString();
        if (chargesDisplay) chargesDisplay.textContent = criminalCharges.toLocaleString();
        if (chargeCostDisplay) chargeCostDisplay.textContent = currentChargeCost.toLocaleString();

        // Enable/disable criminal charge button
        if (chargeButton) {
            chargeButton.disabled = meth < currentChargeCost;
            chargeButton.classList.toggle('opacity-50', meth < currentChargeCost);
            chargeButton.classList.toggle('cursor-not-allowed', meth < currentChargeCost);
        }

        // Iterate through each upgrade to update its button state and display
        upgrades.forEach(upgrade => {
            const button = document.getElementById(upgrade.id);
            if (button) {
                button.disabled = meth < upgrade.cost;
                button.classList.toggle('opacity-50', meth < upgrade.cost);
                button.classList.toggle('cursor-not-allowed', meth < upgrade.cost);

                let boostText = '';
                if (upgrade.type === 'cpc') {
                    boostText = `+${upgrade.cpc_boost} CPC`;
                } else if (upgrade.type === 'ops') {
                    boostText = `+${upgrade.cps_boost} OPS`;
                }

                button.innerHTML = `
                    <span class="block text-xl">${upgrade.name}</span>
                    <span class="block text-base opacity-90">Cost: ${upgrade.cost.toLocaleString()} Meth (${boostText})</span>
                `;
            }
        });
    }

    /**
     * Handles the main meth button click event.
     * Increases meth by the current CPC and plays the clink sound.
     */
    function clickMeth() {
        meth += cpc;
        updateDisplay();
        
        // Create a new audio element each time to avoid playback issues
        const clinkAudio = new Audio('assets/clink.mp3');
        clinkAudio.volume = (bgMusic ? bgMusic.volume : 0) * clinkVolumeMultiplier;
        clinkAudio.play().catch(error => {
            console.error("Error attempting to play clink audio:", error);
        });
    }

    /**
     * Handles the purchase of an upgrade.
     * @param {string} upgradeId - The ID of the upgrade to purchase.
     */
    function buyUpgrade(upgradeId) {
        const upgrade = upgrades.find(u => u.id === upgradeId);

        if (upgrade && meth >= upgrade.cost) {
            meth -= upgrade.cost;

            if (upgrade.type === 'cpc') {
                cpc += upgrade.cpc_boost;
            } else if (upgrade.type === 'ops') {
                ops += upgrade.cps_boost;
            }

            upgrade.cost = Math.floor(upgrade.cost * 1.5);

            updateDisplay();
            saveGame();
        } else {
            console.log("Cannot buy upgrade: Not enough meth or upgrade not found.");
        }
    }

    /**
     * Initializes the upgrade buttons in the UI.
     * This function is called once when the page loads and after a rebirth.
     */
    function initializeUpgrades() {
        if (!upgradesContainer) {
            console.error("Upgrades container not found. Cannot initialize upgrades.");
            return;
        }
        upgradesContainer.innerHTML = '';

        upgrades.forEach(upgrade => {
            if (criminalCharges >= (upgrade.requiredRebirths || 0)) {
                const button = document.createElement('button');
                button.id = upgrade.id;
                button.className = 'w-full bg-stone-700 hover:bg-stone-800 text-white font-bold py-4 px-8 rounded-md shadow-md transition duration-300 ease-in-out transform active:translate-y-1 focus:outline-none focus:ring-2 focus:ring-stone-400';

                let boostText = '';
                if (upgrade.type === 'cpc') {
                    boostText = `+${upgrade.cpc_boost} CPC`;
                } else if (upgrade.type === 'ops') {
                    boostText = `+${upgrade.cps_boost} OPS`;
                }

                button.innerHTML = `
                    <span class="block text-xl">${upgrade.name}</span>
                    <span class="block text-base opacity-90">Cost: ${upgrade.cost.toLocaleString()} Meth (${boostText})</span>
                `;
                button.onclick = () => buyUpgrade(upgrade.id);
                upgradesContainer.appendChild(button);
            }
        });
    }

    /**
     * Toggles the visibility of the upgrades section.
     */
    function toggleUpgradesVisibility() {
        if (upgradesSection) {
            upgradesSection.classList.toggle('hidden');
        } else {
            console.error("Upgrades section not found. Cannot toggle visibility.");
        }
    }

    /**
     * Resets the game state to its initial values for a "rebirth".
     */
    function criminalCharge() {
        if (meth >= currentChargeCost) {
            meth -= currentChargeCost;
            criminalCharges++;

            currentChargeCost = Math.floor(currentChargeCost * 2);

            meth = 0;
            cpc = 1;
            ops = 0;

            upgrades.forEach(upgrade => {
                if (!upgrade.permanent) {
                    upgrade.cost = upgrade.initialCost;
                }
            });

            const fadeTargetVolume = Math.max(originalBgVolume * minBgVolumeMultiplier, minAbsoluteBgVolume);
            
            // Fade out background music before playing the charge audio
            fadeAudio(bgMusic, fadeTargetVolume, fadeDuration, () => {
                if (walterAudio && walterAudio.readyState >= 3) {
                    walterAudio.volume = originalBgVolume;
                    walterAudio.currentTime = 0;
                    walterAudio.play().catch(error => {
                        console.error("Error attempting to play criminal charge audio:", error);
                    });
                }
            });

            initializeUpgrades();
            updateDisplay();
            saveGame();
        } else {
            console.log("Not enough meth for criminal charge!");
        }
    }
    
    // Add an event listener to the Walter audio to fade the music back in when it ends
    if (walterAudio) {
        walterAudio.src = 'assets/Walta.mp3';
        walterAudio.addEventListener('ended', () => {
            // Fade the background music back to its original volume, which may have been changed by the slider
            fadeAudio(bgMusic, originalBgVolume, fadeDuration);
        });
    }

    /**
     * Game loop function to automatically add cookies based on OPS.
     * This function runs every second.
     */
    function gameLoop() {
        meth += ops;
        updateDisplay();
    }

    /**
     * Saves the current game state to localStorage.
     */
    function saveGame() {
        const gameData = {
            meth: meth,
            cpc: cpc,
            ops: ops,
            criminalCharges: criminalCharges,
            currentChargeCost: currentChargeCost,
            upgrades: upgrades.map(u => ({ id: u.id, cost: u.cost })),
            lastPlayedTime: Date.now()
        };
        try {
            localStorage.setItem('walterWhiteClickerSave', JSON.stringify(gameData));
            console.log("Game saved!");
        } catch (e) {
            console.error("Error saving game to localStorage:", e);
        }
    }

    /**
     * Loads the game state from localStorage and handles offline progression.
     */
    function loadGame() {
        try {
            const savedData = localStorage.getItem('walterWhiteClickerSave');
            if (savedData) {
                const gameData = JSON.parse(savedData);

                meth = gameData.meth || 0;
                cpc = gameData.cpc || 1;
                ops = gameData.ops || 0;
                criminalCharges = gameData.criminalCharges || 0;
                currentChargeCost = gameData.currentChargeCost || 30000;

                if (gameData.upgrades) {
                    gameData.upgrades.forEach(savedUpgrade => {
                        const localUpgrade = upgrades.find(u => u.id === savedUpgrade.id);
                        if (localUpgrade) {
                            localUpgrade.cost = savedUpgrade.cost;
                        }
                    });
                }

                const lastPlayedTime = gameData.lastPlayedTime;
                if (lastPlayedTime && ops > 0) {
                    const timeElapsedMs = Date.now() - lastPlayedTime;
                    const timeElapsedSeconds = Math.floor(timeElapsedMs / 1000);
                    const offlineMeth = ops * timeElapsedSeconds;

                    if (offlineMeth > 0) {
                        showOfflineCollectMenu(offlineMeth);
                    }
                }
                console.log("Game loaded!");
            } else {
                console.log("No saved game found. Starting new game.");
            }
        } catch (e) {
            console.error("Error loading game from localStorage:", e);
            localStorage.removeItem('walterWhiteClickerSave');
            console.log("Corrupted save detected and cleared. Starting new game.");
        }
    }

    /**
     * Displays the offline cookie collection modal.
     * @param {number} amount - The amount of cookies earned offline.
     */
    function showOfflineCollectMenu(amount) {
        if (offlineModal && offlineCookiesAmountDisplay) {
            offlineCookiesAmountDisplay.textContent = amount.toLocaleString();
            offlineModal.classList.remove('hidden');

            collectOfflineButton.onclick = () => {
                meth += amount;
                updateDisplay();
                offlineModal.classList.add('hidden');
                saveGame();
            };

            dontCollectOfflineButton.onclick = () => {
                offlineModal.classList.add('hidden');
                saveGame();
            };
        } else {
            console.error("Offline modal elements not found.");
        }
    }

    // Event Listener for the main meth button
    if (methButton) {
        methButton.addEventListener('click', clickMeth);
    } else {
        console.error("Meth button not found. Click functionality will not work.");
    }

    // Event Listener for the new toggle upgrades button
    if (toggleUpgradesButton) {
        toggleUpgradesButton.addEventListener('click', toggleUpgradesVisibility);
    } else {
        console.error("Toggle Upgrades button not found. Toggle functionality will not work.");
    }

    // Event Listener for the criminal charge button
    if (chargeButton) {
        chargeButton.addEventListener('click', function() {
            criminalCharge();
        });
    } else {
        console.error("Criminal Charge button not found. Functionality will not work.");
    }


    // Initialize the game when the window loads
    window.onload = function() {
        try {
            loadGame();
            initializeUpgrades();
            updateDisplay();
            setInterval(gameLoop, 1000);
            setInterval(saveGame, 5000);
        } catch (error) {
            console.error("An error occurred during game initialization:", error);
        }
    };

    // Save game when the user leaves or closes the page
    window.onbeforeunload = saveGame;
</script>
</body>
</html>
